#...............................................................................
# COMPONENTES MENSAIS ====
#...............................................................................
#.......... Preços Livres ====
#...............................................................................
p_livre <- rbcb::get_series(11428, start_date = "2010-01-01") %>%
  as_tibble() %>%
  rename(valor = `11428`) %>%
  arrange(date) %>% 
  filter(date < as.Date('2025-01-01'))

#...............................................................................
#.......... Preços Administrados ====
#...............................................................................
p_admin <- rbcb::get_series(4449, start_date = "2010-01-01") %>%
  as_tibble() %>%
  rename(valor = `4449`) %>%
  arrange(date) %>% 
  filter(date < as.Date('2025-01-01'))

#...............................................................................
#.......... Expectations ====
#...............................................................................
source('get_expectations.R')
exp <- exp %>% 
  filter(date < as.Date('2025-01-01'))

#...............................................................................
#.......... Exchange Rate BRL/US$ ====
#...............................................................................
getSymbols("BRL=X", src = "yahoo", from = "2000-01-01")
cambio <- tibble(
  data = index(`BRL=X`),
  valor = as.numeric(Cl(`BRL=X`))
)

cambio <- cambio %>%
  mutate(mes = floor_date(data, "month")) %>%
  group_by(mes) %>%
  summarise(valor = mean(valor, na.rm = TRUE)) %>%
  ungroup() %>%
  rename(date = mes) %>% 
  filter(date >= as.Date('2010-01-01')) %>% 
  filter(date < as.Date('2025-01-01'))

rm('BRL=X')

#...............................................................................
#.......... i (nominal interest rate) ====
#...............................................................................
selic <- ipeadatar::ipeadata("BM12_TJOVER12") %>%
  dplyr::select(date, valor = value) %>%
  filter(date >= as.Date('2010-01-01')) %>% 
  arrange(date) %>% 
  filter(date < as.Date('2025-01-01'))

#...............................................................................
#.......... r (real interest rate) ====
#...............................................................................
r <- tibble(date = selic$date,
            value = selic$valor - exp$values)

#...............................................................................
#.......... Produção Industrial Brasil ====
#...............................................................................
pi <- rbcb::get_series(21859, start_date = "2010-01-01") %>%
  as_tibble() %>%
  rename(valor = `21859`) %>%
  arrange(date) %>% 
  filter(date < as.Date('2025-01-01'))

#...............................................................................
#.......... Moeda ====
#...............................................................................
m1 <- rbcb::get_series(27791, start_date = "2010-01-01") %>%
  as_tibble() %>%
  rename(valor = `27791`) %>%
  arrange(date) %>% 
  filter(date < as.Date('2025-01-01'))

#...............................................................................
# COMPONENTES TRIMESTRAIS ====
#...............................................................................
#.......... Preços Livres ====
#...............................................................................
p_livre_T <- to_quarterly(p_livre, valor)

#...............................................................................
#.......... Preços Administrados ====
#...............................................................................
p_admin_T <- to_quarterly(p_livre, valor)

#...............................................................................
#.......... Expectations ====
#...............................................................................
exp_T <- to_quarterly(exp, valor)

#...............................................................................
#.......... Exchange Rate BRL/US$ ====
#...............................................................................
cambio_T <- to_quarterly(cambio, valor)

#...............................................................................
#.......... i (nominal interest rate) ====
#...............................................................................
selic_T <- to_quarterly(selic, valor)

#...............................................................................
#.......... Produção Industrial Brasil ====
#...............................................................................
pi_T <- to_quarterly(pi, valor)

#...............................................................................
#.......... Moeda ====
#...............................................................................
m1_T <- to_quarterly_last(m1, valor)

#...............................................................................
#.......... EMBI (premio de risco) ====
#...............................................................................
# Treasury 3M (EUA) – FRED
getSymbols("DTB3", src = "FRED", from = "2010-01-01")
us3m <- tibble(
  date = index(DTB3),
  us3m = as.numeric(DTB3$DTB3)
)

risco <- full_join(selic, us3m, by = "date") %>%
  mutate(date = floor_date(date, "month")) %>%
  group_by(date) %>%
  summarise(
    selic = mean(valor, na.rm = TRUE),
    us3m = mean(us3m, na.rm = TRUE)
  ) %>%
  mutate(
    risco = selic - us3m  # spread simples (% a.a.)
  ) %>%
  filter(!is.na(risco)) %>%
  mutate(valor = risco * 100) %>% 
  dplyr::select(date, valor)

risco_T <- to_quarterly(risco, valor)

#...............................................................................
# COMPONENTES MENSAIS ====
#...............................................................................
#.......... ATIVIDADE ECONOMICA ====
#...............................................................................
#.................... Comercio Varegista ====
#...............................................................................

#...............................................................................
#.................... Energia Eletrica ====
#...............................................................................

#...............................................................................
#.................... PIB ====
#...............................................................................

#...............................................................................
#.................... Capacidade instalada ====
#...............................................................................

#...............................................................................
#.................... Desemprego ====
#...............................................................................
